<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тайна Рукописи Войнича</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .terminal-box {
            background-color: #2d3748; /* Darker slate */
            border-left: 4px solid #667eea; /* Indigo 400 */
            min-height: 400px;
            white-space: pre-wrap;
            line-height: 1.6;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            border-radius: 0.5rem;
            overflow-y: auto;
        }
        .interaction-area {
            background-color: #1a202c;
            padding: 1rem;
            border-top: 1px solid #4a5568;
        }
        .action-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
        }
        .action-button:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .text-input {
            background-color: #1f2937; /* Even darker for input */
            border-color: #4a5568;
            color: #ffffff;
            border-radius: 0.5rem;
        }
        .text-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 1px #667eea;
        }
        .clue-box {
            background-color: #3e4e64;
            padding: 16px;
            margin-top: 20px;
            border-radius: 0.5rem;
            border: 1px solid #718096;
            font-size: 0.95em;
        }
        .hint-box {
            background-color: #1f2937;
            padding: 12px;
            border-radius: 0.5rem;
            margin-top: 12px;
            border: 1px dashed #fcd34d;
        }
        .task-font {
            font-size: 1.5rem; /* Increased font size for the task */
            line-height: 2rem;
        }
        .incorrect-answer {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            20%, 60% {transform: translateX(-5px);}
            40%, 80% {transform: translateX(5px);}
        }
    </style>
</head>
<body class="p-4 md:p-8 flex justify-center items-center min-h-screen">

<div class="w-full max-w-4xl rounded-xl shadow-2xl p-6 md:p-10 border border-gray-700">
    <h1 class="text-3xl md:text-4xl font-bold mb-2 text-indigo-400 text-center">
        ПРОТОКОЛ "АРХИВ 408": РУКОПИСЬ ВОЙНИЧА
    </h1>
    <p class="text-center text-sm mb-6 text-gray-400">
        Криптоаналитик: Инициализация. Стадия: <span id="stageDisplay" class="font-bold text-yellow-400">ДОСЬЕ 00</span> | Попыток: <span id="attemptsDisplay" class="font-bold text-red-400">3</span>
    </p>

    <!-- Output Terminal (Dossier / Task) -->
    <div id="terminalOutput" class="terminal-box p-5 text-sm md:text-base font-mono mb-6">
        <!-- Content loaded by JS -->
    </div>

    <!-- Interaction Area -->
    <div id="interactionArea" class="interaction-area rounded-lg space-y-4">
        <!-- Dynamic buttons and input fields -->
    </div>

    <!-- Modal for messages -->
    <div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center">
        <div class="bg-gray-900 p-6 rounded-lg shadow-xl max-w-sm w-full border border-red-700">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 text-red-400">Уведомление</h3>
            <p id="modalMessage" class="mb-6 text-gray-300"></p>
            <button onclick="hideModal()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 action-button">
                Продолжить
            </button>
        </div>
    </div>
</div>

<script type="text/javascript">
    // Global game state
    let gameState = {
        currentStage: 0,
        stageNames: [
            "ДОСЬЕ 00: БРИФИНГ",
            "ДОСЬЕ 01: НАХОДКА В ИТАЛИИ",
            "ДОСЬЕ 02: БОТАНИЧЕСКИЙ ТРАКТАТ",
            "ДОСЬЕ 03: ЗАСЕКРЕЧЕННОЕ ПИСЬМО", // НОВЫЙ ЭТАП
            "ДОСЬЕ 04: ЗАГАДКА ШИФРА",
            "ДОСЬЕ 05: АНОМАЛИЯ ПЕРЕПЛЕТА",
            "ДОСЬЕ 06: ТЕОРИЯ СКРЫТОГО ТЕКСТА",
            "ДОСЬЕ 07: ОКОНЧАТЕЛЬНЫЙ ВЫВОД"
        ],
        attempts: 3, // Установлено 3 попытки
        hintsRevealed: {}
    };

    /** Vigenere Cipher implementation for the new puzzle */
    const RUS_ALPHABET = 'АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ';
    const RUS_ALPHABET_LOWER = 'абвгдеёжзийклмнопрстуфхцчшщъыьэюя';
    
    // Function to decrypt Vigenere (only supports Russian for this puzzle)
    function vigenereDecrypt(ciphertext, key) {
        let decrypted = '';
        let keyIndex = 0;
        const alphabet = RUS_ALPHABET_LOWER;
        
        // Normalize key
        const normalizedKey = key.toLowerCase().replace(/[^а-яё]/g, '');

        for (let i = 0; i < ciphertext.length; i++) {
            let char = ciphertext[i].toLowerCase();
            const charIndex = alphabet.indexOf(char);
            
            if (charIndex === -1) {
                // Keep spaces and unknown characters as is
                decrypted += ciphertext[i]; 
                continue;
            }

            const keyChar = normalizedKey[keyIndex % normalizedKey.length];
            const keyCharIndex = alphabet.indexOf(keyChar);
            
            // Decryption formula: (C - K + 33) mod 33
            let newIndex = (charIndex - keyCharIndex + alphabet.length) % alphabet.length;
            
            let newChar = alphabet[newIndex];
            
            // Restore original case (simple check for uppercase in the original)
            if (ciphertext[i] === ciphertext[i].toUpperCase() && ciphertext[i].match(/[А-ЯЁ]/)) {
                newChar = newChar.toUpperCase();
            }

            decrypted += newChar;
            keyIndex++;
        }
        return decrypted;
    }

    // Investigation stages (7 Dossiers + Start)
    const stages = [
        { // Stage 0: Start
            output: "ДОБРО ПОЖАЛОВАТЬ, АНАЛИТИК. Вы возглавляете операцию 'АРХИВ 408'. Ваша задача — определить подлинность и содержание таинственной Рукописи XV века, написанной на неизвестном языке.\n\n<span class='text-indigo-300'>Цель:</span> Расшифровать или признать мистификацией.",
            taskType: 'button',
            task: {
                buttonText: "ПРИНЯТЬ ДОСЬЕ 01",
                correctAnswer: true,
                successMsg: "Досье 01 загружено. Приступаем к истории обнаружения.",
                nextStage: 1 
            }
        },
        { // Stage 1: Acquisition (ВОЙНИЧ)
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 01: НАХОДКА В ИТАЛИИ</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (1912 г.):</span> Рукопись приобретена в иезуитской коллегии Вилла Мондрагоне. До этого она долгое время хранилась у европейских ученых, включая Иоганна Марци, который адресовал книгу Афанасию Кирхеру.
<div class="clue-box">
    <p class="font-bold text-xl text-indigo-300 mb-2">УЛИКА 1: БИОГРАФИЧЕСКИЙ ФАКТОР</p>
    <p class="text-base">В 1912 году книготорговец из Нью-Йорка, по происхождению литовец, специализировавшийся на редких манускриптах, заключил сделку с иезуитами. Он был убежден в подлинности и значимости книги, считая ее величайшей находкой в своей жизни. Именно благодаря его усилиям по продвижению и продаже, а также его известности в коллекционных кругах, книга получила его имя. Его жена, писательница Этель Лилиан, сыграла роль в первых попытках перевода, но безуспешно.</p>
    <p class="text-xs mt-2 text-gray-400 task-font">
        <span class='text-red-400'>ДЕКОДИРОВАНИЕ:</span> Найдите и введите фамилию книготорговца, чье имя закрепилось за рукописью. (рус. яз., нижний регистр).
    </p>
</div>`,
            taskType: 'text',
            task: {
                correctAnswer: "войнич",
                question: "Введите фамилию:",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 01:</span> Верно. Фамилия книготорговца, который вывел рукопись из тени. Переходим к изучению ее содержания.",
                nextStage: 2,
                hints: ["Имя владельца стало названием книги. Кто это?"]
            }
        },
        { // Stage 2: Botanical Absurdity (ФАНТОМЫ)
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 02: БОТАНИЧЕСКИЙ ТРАКТАТ</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (Секция "Ботаника"):</span> В манускрипте представлено 113 изображений растений, которые до сих пор не удалось идентифицировать. Радиоуглеродный анализ пергамента подтверждает XV век.
<div class="clue-box">
    <p class="font-bold text-xl text-indigo-300 mb-2">УЛИКА 2: АНАЛИЗ ИЛЛЮСТРАЦИЙ</p>
    <p class="text-base">Исследование ботаниками профессором Р. Такером и другими экспертами показало, что растения не существуют в реальной флоре. Это не просто стилизованные или экзотические виды, а **химерические композиции**. У них может быть стебель одного известного европейского растения, листья другого, а цветок третьего, часто изображенного с корнями, но без тени. Они являются абсолютными **биологическими аномалиями**, не поддающимися таксономической классификации, как будто они были просто придуманы.</p>
    <p class="text-xs mt-2 text-gray-400 task-font">
        <span class='text-red-400'>ДЕКОДИРОВАНИЕ:</span> Опишите одним словом, что представляют собой эти несуществующие, химерические растения. (множественное число, нижний регистр).
    </p>
</div>`,
            taskType: 'text',
            task: {
                correctAnswer: "фантомы",
                question: "Введите слово, описывающее несуществующие растения (мн.ч.):",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 02:</span> Фантомы! Если предмет изображения вымышлен, это критический индикатор. Перед анализом структуры текста, проверим слухи о скрытом послании.",
                nextStage: 3, // Переход на новый этап 3
                hints: ["Иллюзорные, вымышленные объекты, не имеющие реального аналога."]
            }
        },
        { // Stage 3: NEW CRYPTO STAGE (ВОЗРАСТА)
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 03: ЗАСЕКРЕЧЕННОЕ ПИСЬМО</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (Обнаружение):</span> На задней обложке рукописи, под слоем клея, обнаружены микроскопические царапины, формирующие последовательность символов, нанесенных, предположительно, более поздним пером. Шифр принадлежит к классу **полиалфавитных**, требующих ключевого слова.
<div class="clue-box">
    <p class="font-bold text-xl text-indigo-300 mb-2">УЛИКА 3: ШИФРОВАЛЬНЫЙ БЛОК</p>
    <p class="text-base font-bold text-red-300 text-lg md:text-xl">ШИФРОТЕКСТ: <span class="text-yellow-400">НЖЖШЧФЦК ЦЩЮЦЩА ЧАЖСЬНЭ</span></p>
    <p class="text-base mt-2">Ключевое слово для расшифровки,связано с единственным физическим доказательством подлинности манускрипта, которое было получено с помощью радиоуглеродного анализа.</p>
    <p class="text-xs mt-2 text-gray-400 task-font">
        <span class='text-red-400'>ДЕКОДИРОВАНИЕ:</span> Расшифруйте фразу, используя ключевое слово, связанное с датированным материалом. Введите **ключевое слово из расшифрованной фразы**, которое указывает на аномалию (рус. яз., нижний регистр).
    </p>
    <p class="text-xs mt-2 text-green-400 font-mono">
        <!-- Vigenere Decrypted: АРТЕФАКТ АНОМАЛИИ ВОЗРАСТА (Key: ПЕРГАМЕНТ) -->
        (Подсказка: ищите слово-вывод из трех слов в расшифрованной фразе.)
    </p>
</div>`,
            taskType: 'text',
            task: {
                correctAnswer: "возраста",
                question: "Введите ключевое слово-вывод из расшифровки:",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 03:</span> Расшифровано: АРТЕФАКТ АНОМАЛИИ ВОЗРАСТА. Вывод о том, что пергамент старше чернил, подтверждает теорию мистификации. Переходим к структуре текста Войнича.",
                nextStage: 4,
                hints: ["Ключ к шифру — это материал, из которого сделаны страницы."]
            }
        },
        { // Stage 4: Cipher Structure (СЛОГИ) - Old Stage 3
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 04: ЗАГАДКА ШИФРА</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (Криптоанализ):</span> Текст написан уникальным, нелатинским алфавитом (Войничевский алфавит). Анализ показал, что Закон Ципфа (распределение частоты слов) не соблюдается в полной мере.
<div class="clue-box">
    <p class="font-bold text-xl text-indigo-300 mb-2">УЛИКА 4: КВАНТИТАТИВНЫЙ АНАЛИЗ ТЕКСТА</p>
    <p class="text-base">Исследование, проведенное в 1970-х годах, выявило чрезвычайно низкую лексическую плотность и высокую степень избыточности. Слова в тексте Войнича почти всегда формируются из ограниченного набора очень часто повторяющихся коротких последовательностей символов (из двух-трех знаков). Это выглядит как искусственное письмо, созданное путем многократного комбинирования базовых звуковых/графических единиц, а не естественный язык, который имеет более сложное и вариативное распределение букв и слов.</p>
    <p class="text-xs mt-2 text-gray-400 task-font">
        <span class='text-red-400'>ДЕКОДИРОВАНИЕ:</span> Назовите базовые, наименьшие единицы произношения, из которых складываются слова в таком искусственном конструкте. (множественное число, нижний регистр).
    </p>
</div>`,
            taskType: 'text',
            task: {
                correctAnswer: "слоги",
                question: "Введите слово, описывающее строительные блоки (мн.ч.):",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 04:</span> Слоги! Избыточное слоговое письмо — важный признак имитации языка. Переходим к физическим аномалиям.",
                nextStage: 5,
                hints: ["Ключевые 'кирпичики' речи, состоящие из гласного и согласного."]
            }
        },
        { // Stage 5: Quire Structure (РАЗВОРОТЫ) - Old Stage 4
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 05: АНОМАЛИЯ ПЕРЕПЛЕТА</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (Космология и Гидрология):</span> Разделы "Космология" и "Гидрология" содержат иллюстрации, которые требуют гораздо большего пространства, чем стандартный пергаментный лист.
<div class="clue-box">
    <p class="font-bold text-xl text-indigo-300 mb-2">УЛИКА 5: СТРУКТУРА ТЕТРАДЕЙ</p>
    <p class="text-base">Физическое исследование, проведенное в Йельском университете (Библиотека редких книг Бейнеке), подтвердило, что рукопись состоит из нескольких тетрадей (quires). В некоторых из них, особенно там, где изображены астрономические 'Розетки' и сложная 'Гидрология' (бассейны и трубы), листы пергамента были сложены не вдвое, а в несколько раз (от 3 до 6 секций). При полном раскрытии они образуют панорамные карты или диаграммы, демонстрирующие крупномасштабные, сложные сцены. Это очень редкое решение для средневекового манускрипта.</p>
    <p class="text-xs mt-2 на text-gray-400 task-font">
        <span class='text-red-400'>ДЕКОДИРОВАНИЕ:</span> Назовите тип страниц, которые складываются в несколько раз для создания панорамных иллюстраций. (множественное число, нижний регистр).
    </p>
</div>`,
            taskType: 'text',
            task: {
                correctAnswer: "развороты",
                question: "Введите тип страниц (мн.ч.):",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 05:</span> Развороты. Физическое устройство книги так же необычно, как и ее содержание. Переходим к криптографической гипотезе.",
                nextStage: 6,
                hints: ["Панорамные страницы, которые 'раскладываются'."]
            }
        },
        { // Stage 6: Steganography (СТЕГАНОГРАФИЯ) - Old Stage 5
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 06: ТЕОРИЯ СКРЫТОГО ТЕКСТА</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (Гипотеза):</span> Избыточность текста (Досье 04) породила теорию о том, что видимый текст не несет смысла, а является лишь обфускационным слоем (шумом), скрывающим настоящее сообщение.
<div class="clue-box">
    <p class="font-bold text-xl text-indigo-300 mb-2">УЛИКА 6: МЕТОДЫ ТАЙНОПИСИ</p>
    <p class="text-base">В отличие от криптографии, которая шифрует сообщение, этот метод стремится скрыть сам факт его существования. Сообщение вкладывается в совершенно **безобидный контейнер**, например, в текст, не имеющий смысла. В случае Войнича, 'безобидный контейнер' — это тысячи слогоподобных, высокочастотных слов. Если сообщение спрятано внутри этого 'шума', то попытки расшифровать сам алфавит обречены на провал.</p>
    <p class="text-xs mt-2 text-gray-400 task-font">
        <span class='text-red-400'>ДЕКОДИРОВАНИЕ:</span> Введите название криптографического метода сокрытия сообщения в другом тексте. (рус. яз., нижний регистр).
    </p>
</div>`,
            taskType: 'text',
            task: {
                correctAnswer: "стеганография",
                question: "Введите название метода сокрытия сообщения:",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 06:</span> Стеганография. Если текст — это контейнер для шума, то его невозможно расшифровать. Переходим к окончательному вердикту.",
                nextStage: 7,
                hints: ["Искусство маскировки, при котором секретность заключается в невидимости."]
            }
        },
        { // Stage 7: Final Conclusion (МИСТИФИКАЦИЯ) - Old Stage 6
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 07: ОКОНЧАТЕЛЬНЫЙ ВЫВОД</span>

<span class='text-indigo-300'>ОБОБЩЕНИЕ СВОДОК:</span> 
1. **Приобретение:** Имя, ставшее брендом (Войнич).
2. **Содержание:** Несуществующие, химерические растения (Фантомы).
3. **Аномалия:** Артефакт с аномалией **возраста**.
4. **Структура языка:** Искусственная избыточность (Слоги).
5. **Теория:** Обфускационный слой (Стеганография).

<div class="clue-box">
    <p class="font-bold text-xl text-indigo-300 mb-2">УЛИКА 7: КОНСЕНСУС КРИПТОАНАЛИТИЧЕСКОГО СООБЩЕСТВА (2020 г.)</p>
    <p class="text-base">Современный консенсус криптоаналитиков и лингвистов склоняется к одному выводу. Несмотря на то, что пергамент был датирован XV веком, что придавало книге 'подлинность' возраста, все остальные элементы (несуществующие изображения, статистически аномальный текст) указывают на создание артефакта с **намеренной неразрешимостью**. Книга, вероятно, была создана в период Возрождения или даже позже, с целью введения в заблуждение коллекционеров и получения высокой прибыли.</p>
    <p class="text-xs mt-2 text-gray-400 task-font">
        <span class='text-red-400'>ДЕКОДИРОВАНИЕ:</span> Сформулируйте окончательный вывод. Введите ОДНО слово, описывающее подделку с целью обмана (рус. яз., нижний регистр).
    </p>
</div>`,
            taskType: 'finalConclusion',
            task: {
                question: "Введите ОДНО слово, описывающее обман:",
                correctAnswer: "мистификация",
                successMsg: (input) => {
                    return `
                    <span class='text-green-400'>ОКОНЧАТЕЛЬНЫЙ АНАЛИЗ:</span> ПРИНЯТ. ${input.toUpperCase()}.
                    
                    <hr class='my-4 border-gray-600'>
                    
                    <h3 class='text-2xl font-bold text-red-400'>ПРОТОКОЛ ВЫПОЛНЕН: ИСТИНА РУКОПИСИ ВОЙНИЧА</h3>
                    <p>Ваш вывод полностью совпадает с ведущей криптоаналитической теорией: Рукопись Войнича — это, скорее всего, <span class='font-extrabold text-red-300'>${input.toUpperCase()}</span>, блестяще выполненная с использованием пергамента XV века. Она создана как **намеренно неразрешимая** загадка для получения финансовой выгоды. Ваше расследование завершено. </p>
                    `;
                },
                nextStage: 8,
                hints: ["Искусный, но ложный 'шедевр' обмана."]
            }
        }
    ];

    /** Updates the attempts counter in the UI */
    function updateAttemptsDisplay() {
        document.getElementById('attemptsDisplay').textContent = gameState.attempts;
    }

    /** Show Modal Window */
    function showModal(title, message, isError = false, afterAction = null) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').innerHTML = message;
        
        document.getElementById('modalTitle').classList.remove('text-red-400', 'text-green-400');
        document.getElementById('modalTitle').classList.add(isError ? 'text-red-400' : 'text-green-400');
        
        const continueButton = document.querySelector('#messageModal button');
        
        // Custom action runs on modal close via hideModal
        continueButton.onclick = () => {
            if (afterAction) {
                // Execute action before hiding the modal, e.g., transition stage
                afterAction(); 
            }
            // If the modal is related to an error and attempts ran out, handle game over here
            if (gameState.attempts <= 0 && isError) {
                handleGameOver();
            } else {
                hideModal();
            }
        };

        document.getElementById('messageModal').classList.remove('hidden');
    }

    /** Hide Modal Window */
    function hideModal() {
        document.getElementById('messageModal').classList.add('hidden');
    }

    /** Game Over */
    function handleGameOver() {
        // Ensure the game is over if attempts hit zero
        if (gameState.attempts <= 0) {
            document.getElementById('stageDisplay').textContent = "ПРОВАЛ";
            document.getElementById('terminalOutput').innerHTML = `<p class="text-3xl text-red-400 font-bold text-center">МИССИЯ ПРОВАЛЕНА</p><p class="mt-4 text-gray-300 text-center">Ваши попытки исчерпаны. Доступ к архиву заблокирован. Тайна Рукописи Войнича останется неразгаданной.</p>`;
            document.getElementById('interactionArea').innerHTML = `<p class="text-3xl text-red-400 font-bold mt-8 text-center">РАССЛЕДОВАНИЕ ЗАКРЫТО.</p>`;
        }
    }

    /** General Failure Handler */
    function handleFailure(message) {
        gameState.attempts--;
        updateAttemptsDisplay();
        document.getElementById('terminalOutput').classList.add('incorrect-answer');
        setTimeout(() => document.getElementById('terminalOutput').classList.remove('incorrect-answer'), 500);

        if (gameState.attempts <= 0) {
            handleGameOver();
        } else {
            handleTextQuizError(message);
        }
    }
    
    /** Specific handler for quiz errors to show remaining attempts */
    function handleTextQuizError(message) {
         showModal("ОШИБКА АНАЛИЗА", message + `<br><br>У вас осталось **${gameState.attempts}** попыток. Пересмотрите УЛИКИ.`, true);
    }

    /** New function to handle skipping a dossier */
    function handleSkip() {
        const stageIndex = gameState.currentStage;
        if (stageIndex >= stages.length - 1 || stageIndex === 0) return; // Cannot skip final or initial stage

        gameState.attempts--;
        updateAttemptsDisplay();

        if (gameState.attempts <= 0) {
            handleGameOver();
            return;
        }

        const skippedStageName = gameState.stageNames[stageIndex];
        const nextStageIndex = stageIndex + 1;

        showModal(
            "ДОСЬЕ ПРОПУЩЕНО", 
            `Вы решили пропустить **${skippedStageName}**. За это вы потеряли 1 попытку. Осталось **${gameState.attempts}** попыток. Загрузка следующего Досье...`, 
            true, 
            () => {
                // This function executes when the user closes the modal
                gameState.currentStage = nextStageIndex;
                loadStage(gameState.currentStage);
            }
        );
    }

    /** Reveals the hidden Hint */
    function revealHint() {
        const stageIndex = gameState.currentStage;
        const stageData = stages[stageIndex];
        
        if (!stageData.task.hints || gameState.hintsRevealed[stageIndex]) return;

        const hintText = stageData.task.hints.join('<br>');

        // Mark hint as revealed
        gameState.hintsRevealed[stageIndex] = true;
        
        // Show modal with the hint text, and use afterAction to reload the current stage
        showModal(
            "ПОДСКАЗКА АКТИВИРОВАНА", 
            `Криптическая подсказка для дедукции: <span class="font-bold text-yellow-300">${hintText}</span>. Она добавлена в ваше Досье.`, 
            false, 
            () => loadStage(stageIndex) 
        );
    }

    /** Loads and displays the current stage */
    function loadStage(stageIndex) {
        if (stageIndex >= stages.length) {
            document.getElementById('stageDisplay').textContent = "ЗАВЕРШЕНО";
            return;
        }

        const stageData = stages[stageIndex];
        const outputElement = document.getElementById('terminalOutput');
        const interactionElement = document.getElementById('interactionArea');
        
        document.getElementById('stageDisplay').textContent = gameState.stageNames[stageIndex];
        updateAttemptsDisplay();
        
        // Load main content
        outputElement.innerHTML = `<span class='font-bold text-indigo-300'>${gameState.stageNames[stageIndex]}</span>\n\n${stageData.output}`;
        
        // Display the required input question below the content
        if (stageData.taskType === 'text' || stageData.taskType === 'finalConclusion') {
            outputElement.innerHTML += `<p class="mt-6 text-yellow-400 font-bold task-font">${stageData.task.question}</p>`;
        }
        
        // If hint was revealed, display the hint content
        if (gameState.hintsRevealed[stageIndex] && stageData.task.hints) {
            let hintHtml = `<div class="hint-box"><p class="font-bold text-yellow-400 mb-2">ПОДСКАЗКА:</p><ul>`;
            stageData.task.hints.forEach(hint => {
                hintHtml += `<li>"${hint}"</li>`; 
            });
            hintHtml += `</ul></div>`;
            outputElement.innerHTML += hintHtml; 
        }


        interactionElement.innerHTML = '';

        if (stageIndex === 0) {
            // Start button
            const button = document.createElement('button');
            button.textContent = stageData.task.buttonText;
            button.className = 'action-button w-full bg-indigo-600 text-white py-3 font-semibold hover:bg-indigo-700';
            // On success for Stage 0, we transition to the next stage
            button.onclick = () => showModal("АНАЛИЗ УСПЕШЕН", stageData.task.successMsg, false, () => {
                gameState.currentStage = stageData.task.nextStage;
                loadStage(gameState.currentStage);
            });
            interactionElement.appendChild(button);
        } else if (stageData.taskType === 'text' || stageData.taskType === 'finalConclusion') {
            // Text input for quiz
            const task = stageData.task;
            
            // --- Input and Submit Button ---
            const inputGroup = document.createElement('div');
            inputGroup.className = 'flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4';
            
            const inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.id = 'stageInput';
            inputField.className = 'flex-grow p-3 text-input';
            inputField.placeholder = "Введите ключевое слово...";
            
            const button = document.createElement('button');
            button.id = 'submitBtn';
            button.textContent = 'ПОДТВЕРДИТЬ УЛИКУ';
            button.className = 'action-button bg-red-600 text-white py-3 px-6 font-semibold hover:bg-red-700 w-full md:w-auto';
            button.onclick = () => {
                if (stageData.taskType === 'finalConclusion') {
                    handleFinalConclusion(task, stageData);
                } else {
                    handleTextQuiz(task, stageData);
                }
            };

            // Handle Enter keypress
            inputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent form submission
                    button.click();
                }
            });
            
            inputGroup.appendChild(inputField);
            inputGroup.appendChild(button);
            interactionElement.appendChild(inputGroup);
            
            // --- Hint and Skip Buttons ---
            const utilityGroup = document.createElement('div');
            utilityGroup.className = 'flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2';
            
            const hintButton = document.createElement('button');
            hintButton.id = 'hintBtn';
            hintButton.textContent = gameState.hintsRevealed[stageIndex] ? "ПОДСКАЗКА АКТИВИРОВАНА" : "ПОЛУЧИТЬ ПОДСКАЗКУ";
            hintButton.className = 'action-button bg-yellow-600 text-white py-3 px-6 font-semibold hover:bg-yellow-700 w-full md:w-1/2';
            hintButton.disabled = gameState.hintsRevealed[stageIndex] === true; 
            hintButton.onclick = revealHint;
            
            utilityGroup.appendChild(hintButton);

            // Skip Button Logic (For stages 1 through 6)
            if (stageIndex >= 1 && stageIndex <= 6) {
                const skipButton = document.createElement('button');
                skipButton.id = 'skipBtn';
                skipButton.textContent = 'ПРОПУСТИТЬ ДОСЬЕ (-1 ПОПЫТКА)';
                skipButton.className = 'action-button bg-gray-600 text-white py-3 px-6 font-semibold hover:bg-gray-700 w-full md:w-1/2';
                skipButton.onclick = handleSkip;
                utilityGroup.appendChild(skipButton);
            }
            
            interactionElement.appendChild(utilityGroup);
        }
    }

    /** Handles Text Input Quiz */
    function handleTextQuiz(task, stageData) {
        const input = document.getElementById('stageInput').value.trim().toLowerCase();
        
        if (input === task.correctAnswer.toLowerCase()) {
            // Handle success: show modal, then transition stage
            showModal("АНАЛИЗ УСПЕШЕН", stageData.task.successMsg, false, () => {
                 gameState.currentStage = stageData.task.nextStage;
                 loadStage(gameState.currentStage);
            });
        } else if (input.length < 3) {
            showModal("ВНИМАНИЕ", "Введите ключевое слово для продолжения расследования.", true);
        } else {
            handleFailure(`Неверный ключевой фактор: '${input}'. Внимательно изучите УЛИКИ и СВОДКИ.`);
        }
    }

    /** Handles Final Conclusion */
    function handleFinalConclusion(finalTask, stageData) {
        const input = document.getElementById('stageInput').value.trim().toLowerCase();

        if (input === finalTask.correctAnswer.toLowerCase()) {
            // Final conclusion success logic
            document.getElementById('terminalOutput').innerHTML += finalTask.successMsg(input);
            document.getElementById('interactionArea').innerHTML = `<p class="text-xl text-green-400 font-bold text-center">ПРОТОКОЛ ЗАВЕРШЕН</p>`;
            gameState.currentStage = finalTask.nextStage;
            document.getElementById('stageDisplay').textContent = "РАЗГАДАН";
        } else if (input.length < 3) {
            showModal("ВНИМАНИЕ", "Введите ключевое слово для обоснования вашего вывода.", true);
        }
        else {
            handleFailure(`Ваш ключевой фактор ('${input}') не отражает окончательной исторической теории о природе рукописи.`);
        }
    }

    // Initialize the game
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize hints state for all quiz stages (1-7)
        for(let i = 1; i < stages.length; i++) {
            if (gameState.hintsRevealed[i] === undefined) {
                 gameState.hintsRevealed[i] = false;
            }
        }
        loadStage(gameState.currentStage);
    });
</script>

</body>
</html>
