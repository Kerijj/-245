<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тайна Рукописи Войнича</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .terminal-box {
            background-color: #2d3748; /* Darker slate */
            border-left: 4px solid #667eea; /* Indigo 400 */
            min-height: 400px;
            white-space: pre-wrap;
            line-height: 1.6;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            border-radius: 0.5rem;
            overflow-y: auto;
        }
        .interaction-area {
            background-color: #1a202c;
            padding: 1rem;
            border-top: 1px solid #4a5568;
        }
        .action-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
        }
        .action-button:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .text-input {
            background-color: #1f2937; /* Even darker for input */
            border-color: #4a5568;
            color: #ffffff;
            border-radius: 0.5rem;
        }
        .text-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 1px #667eea;
        }
        .clue-box {
            background-color: #3e4e64;
            padding: 16px;
            margin-top: 20px;
            border-radius: 0.5rem;
            border: 1px solid #718096;
            font-size: 0.95em;
        }
        .hint-box {
            background-color: #1f2937;
            padding: 12px;
            border-radius: 0.5rem;
            margin-top: 12px;
            border: 1px dashed #fcd34d;
        }
        .incorrect-answer {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            20%, 60% {transform: translateX(-5px);}
            40%, 80% {transform: translateX(5px);}
        }
    </style>
</head>
<body class="p-4 md:p-8 flex justify-center items-center min-h-screen">

<div class="w-full max-w-4xl rounded-xl shadow-2xl p-6 md:p-10 border border-gray-700">
    <h1 class="text-3xl md:text-4xl font-bold mb-2 text-indigo-400 text-center">
        ПРОТОКОЛ "АРХИВ 408": РУКОПИСЬ ВОЙНИЧА
    </h1>
    <p class="text-center text-sm mb-6 text-gray-400">
        Криптоаналитик: Инициализация. Стадия: <span id="stageDisplay" class="font-bold text-yellow-400">ДОСЬЕ 00</span> | Попыток: <span id="attemptsDisplay" class="font-bold text-red-400">5</span>
    </p>

    <!-- Output Terminal (Dossier / Task) -->
    <div id="terminalOutput" class="terminal-box p-5 text-sm md:text-base font-mono mb-6">
        <!-- Content loaded by JS -->
    </div>

    <!-- Interaction Area -->
    <div id="interactionArea" class="interaction-area rounded-lg space-y-4">
        <!-- Dynamic buttons and input fields -->
    </div>

    <!-- Modal for messages -->
    <div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center">
        <div class="bg-gray-900 p-6 rounded-lg shadow-xl max-w-sm w-full border border-red-700">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 text-red-400">Уведомление</h3>
            <p id="modalMessage" class="mb-6 text-gray-300"></p>
            <button onclick="hideModal()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 action-button">
                Продолжить
            </button>
        </div>
    </div>
</div>

<script type="text/javascript">
    // Global game state
    let gameState = {
        currentStage: 0,
        stageNames: [
            "ДОСЬЕ 00: БРИФИНГ",
            "ДОСЬЕ 01: НАХОДКА В ИТАЛИИ",
            "ДОСЬЕ 02: БОТАНИЧЕСКИЙ ТРАКТАТ",
            "ДОСЬЕ 03: ЗАГАДКА ШИФРА",
            "ДОСЬЕ 04: АНОМАЛИЯ ПЕРЕПЛЕТА",
            "ДОСЬЕ 05: ТЕОРИЯ СКРЫТОГО ТЕКСТА",
            "ДОСЬЕ 06: ОКОНЧАТЕЛЬНЫЙ ВЫВОД"
        ],
        attempts: 5,
        hintsRevealed: {} // Tracks which stage hints have been revealed: {1: false, 2: true, ...}
    };

    // Investigation stages (6 Dossiers + Start)
    const stages = [
        { // Stage 0: Start (FIXED: Added nextStage: 1)
            output: "ДОБРО ПОЖАЛОВАТЬ, АНАЛИТИК. Вы возглавляете операцию 'АРХИВ 408'. Ваша задача — определить подлинность и содержание таинственной Рукописи XV века, написанной на неизвестном языке.\n\n<span class='text-indigo-300'>Цель:</span> Расшифровать или признать мистификацией. ",
            taskType: 'button',
            task: {
                buttonText: "ПРИНЯТЬ ДОСЬЕ 01",
                correctAnswer: true,
                successMsg: "Досье 01 загружено. Приступаем к истории обнаружения.",
                nextStage: 1 // FIX: Ensures transition to stage 1
            }
        },
        { // Stage 1: Acquisition (ВОЙНИЧ)
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 01: НАХОДКА В ИТАЛИИ</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (1912 г.):</span> Рукопись приобретена в иезуитской коллегии Вилла Мондрагоне. Последним известным владельцем до этого был Иоганн Марци (ректор Карлова университета XVII века).
<div class="clue-box">
    <p class="font-bold text-lg text-indigo-300 mb-2">УЛИКА 1: ФАКСИМИЛЕ ТЕЛЕГРАММЫ (1912)</p>
    <p class="text-sm">"Успешная сделка в Риме. Книгу забрал человек, который дал ей свое имя. Передайте информацию его жене, Этель."</p>
    <p class="text-xs mt-2 text-gray-400">
        <span class='text-red-400'>КОДОВЫЙ ФРАГМЕНТ A1:</span> Шифр Цезаря (+1) на имени покупателя: $\\text{В О Й Н И Ч} \\rightarrow \\text{Г П К О К Ш}$ (Это отвлекающая улика, ведущая к тому же слову.)
    </p>
</div>
<span class='text-indigo-300'>ЗАДАНИЕ:</span> Введите фамилию книготорговца, который вывез рукопись и дал ей свое имя. (рус. яз., нижний регистр).`,
            taskType: 'text',
            task: {
                correctAnswer: "войнич",
                question: "Введите фамилию:",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 01:</span> Верно. Книготорговец, давший имя рукописи. Переходим к изучению ее содержания.",
                nextStage: 2,
                hints: ["Уилфрид Войнич 1912", "кто купил рукопись войнича"]
            }
        },
        { // Stage 2: Botanical Absurdity (ФАНТОМЫ)
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 02: БОТАНИЧЕСКИЙ ТРАКТАТ</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (Секция "Ботаника"):</span> Раздел содержит более 100 изображений растений. Радиоуглеродный анализ подтверждает дату: 1404–1438 гг.
<div class="clue-box">
    <p class="font-bold text-lg text-indigo-300 mb-2">УЛИКА 2: ОТЧЕТ ЭКСПЕРТА-БОТАНИКА (1921 г.)</p>
    <p class="text-sm">"Изучение флоры показало, что листья и цветы не соответствуют ни одному известному виду. Они собраны из частей разных растений или полностью вымышлены, представляя собой совокупность несуществующих объектов."</p>
    <p class="text-xs mt-2 text-gray-400">
        <span class='text-red-400'>КОДОВЫЙ ФРАГМЕНТ B1:</span> Применимая к растениям часть шифра: $\\mathbf{F} \\leftarrow 6, \\mathbf{A} \\leftarrow 1, \\mathbf{N} \\leftarrow 5$.
    </p>
</div>

<span class='text-indigo-300'>ЗАДАНИЕ:</span> Опишите одним словом, что представляют собой эти несуществующие растения. (множественное число, нижний регистр).`,
            taskType: 'text',
            task: {
                correctAnswer: "фантомы",
                question: "Введите слово, описывающее несуществующие растения (мн.ч.):",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 02:</span> Фантомы! Если иллюстрации ненастоящие, то и текст, возможно, ненастоящий. Переходим к структуре языка.",
                nextStage: 3,
                hints: ["Рукопись Войнича изображения растений", "фантомные растения войнича"]
            }
        },
        { // Stage 3: Cipher Structure (СЛОГИ)
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 03: ЗАГАДКА ШИФРА</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (Криптоанализ):</span> Текст написан уникальным алфавитом. Анализ частоты показал, что он не подчиняется <span class='text-red-400'>Закону Ципфа</span> (распределение частоты слов в естественном языке).
<div class="clue-box">
    <p class="font-bold text-lg text-indigo-300 mb-2">УЛИКА 3: ЛИНГВИСТИЧЕСКОЕ ИССЛЕДОВАНИЕ (1976 г.)</p>
    <p class="text-sm">"Вместо сложного распределения, большинство 'слов' состоят из повторяющихся 2-3 символьных групп, что указывает на искусственность. Слова являются комбинациями коротких, повторяющихся строительных блоков."</p>
    <p class="text-xs mt-2 text-gray-400">
        <span class='text-red-400'>КОДОВЫЙ ФРАГМЕНТ C1: Псевдо-Азбука.</span> Нарушение Закона Ципфа в тексте обусловлено избыточным использованием коротких **строительных блоков**.
    </p>
</div>

<span class='text-indigo-300'>ЗАДАНИЕ:</span> Введите ключевое слово, описывающее эти короткие, повторяющиеся строительные блоки "языка" (множественное число, нижний регистр).`,
            taskType: 'text',
            task: {
                correctAnswer: "слоги",
                question: "Введите слово, описывающее строительные блоки (мн.ч.):",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 03:</span> Слоги! Их избыточность — ключ к пониманию текста. Переходим к изучению физических аномалий пергамента.",
                nextStage: 4,
                hints: ["Рукопись Войнича нарушает закон Ципфа", "повторяющиеся блоки в тексте Войнича"]
            }
        },
        { // Stage 4: Quire Structure (РАЗВОРОТЫ)
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 04: АНОМАЛИЯ ПЕРЕПЛЕТА</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (Секция "Космология"):</span> Рукопись состоит из 17 тетрадей (quire). В разделе "Космология" есть несколько иллюстраций, которые не поместились на обычные листы.
<div class="clue-box">
    <p class="font-bold text-lg text-indigo-300 mb-2">УЛИКА 4: ОТЧЕТ О КОНСЕРВАЦИИ (1961 г.)</p>
    <p class="text-sm">"Астрологические диаграммы были выполнены на сложенных пергаментах, которые затем пришивались к корешку. Мы обнаружили пять таких уникальных листов, которые раскладываются, увеличивая площадь в несколько раз."</p>
    <p class="text-xs mt-2 text-gray-400">
        <span class='text-red-400'>КОДОВЫЙ ФРАГМЕНТ D1:</span> Количество тетрадей (17) и количество этих сложенных листов (5) — это $\\mathbf{17-5=12}$.
    </p>
</div>

<span class='text-indigo-300'>ЗАДАНИЕ:</span> Назовите тип страниц, которые складываются в несколько раз и содержат самые крупные иллюстрации. (множественное число, нижний регистр).`,
            taskType: 'text',
            task: {
                correctAnswer: "развороты",
                question: "Введите тип страниц, которые складываются в несколько раз (мн.ч.):",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 04:</span> Развороты. Эти структурные аномалии могут быть частью сложного дизайна. Переходим к теории о создании текста.",
                nextStage: 5,
                hints: ["Рукопись Войнича сложенные листы", "книжные развороты"]
            }
        },
        { // Stage 5: Steganography (СТЕГАНОГРАФИЯ)
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 05: ТЕОРИЯ СКРЫТОГО ТЕКСТА</span>
<span class='text-indigo-300'>ИСТОРИЧЕСКАЯ СВОДКА (Гипотеза):</span> Избыточность слогов (Досье 03) привела к теории, что текст является "прикрытием". Возможно, короткое сообщение было "раздуто" до сотен страниц.
<div class="clue-box">
    <p class="font-bold text-lg text-indigo-300 mb-2">УЛИКА 5: ИССЛЕДОВАНИЕ КАНДИДАТА ФИЛОСОФСКИХ НАУК (1985 г.)</p>
    <p class="text-sm">"Метод, при котором полезная информация скрывается в другом, внешне безобидном сообщении, именуется 'письмо с прикрытием'. Он позволяет спрятать реальное сообщение, используя 'пустые' символы или слоги."</p>
    <p class="text-xs mt-2 text-gray-400">
        <span class='text-red-400'>КОДОВЫЙ ФРАГМЕНТ E1:</span> Ключевое слово, сдвинутое на две позиции в алфавите (Шифр Цезаря): УФЖЕБОПЖУБКЗСГН.
    </p>
</div>

<span class='text-indigo-300'>ЗАДАНИЕ:</span> Введите название криптографического метода сокрытия сообщения в другом тексте. (рус. яз., нижний регистр).`,
            taskType: 'text',
            task: {
                correctAnswer: "стеганография",
                question: "Введите название метода сокрытия сообщения в другом тексте:",
                successMsg: "<span class='text-green-400'>АНАЛИЗ 05:</span> Стеганография. Это подтверждает возможность того, что книга является блестящим прикрытием. Переходим к окончательному выводу.",
                nextStage: 6,
                hints: ["метод сокрытия информации в другом сообщении", "стеганография в рукописи войнича"]
            }
        },
        { // Stage 6: Final Conclusion (МИСТИФИКАЦИЯ)
            output: `
<span class='text-yellow-400 font-bold'>ДОСЬЕ 06: ОКОНЧАТЕЛЬНЫЙ ВЫВОД</span>

<span class='text-indigo-300'>ОБОБЩЕНИЕ СВОДОК:</span> 
1. **Находка:** Книготорговец, давший имя.
2. **Содержание:** Растения-несуществующие объекты.
3. **Структура языка:** Повторяющиеся строительные блоки.
4. **Теория:** Использование метода скрытия сообщения.

<p class="text-sm mt-2 text-gray-500">
    <span class='text-green-400'>Подсказка для Google:</span> "теория обмана рукопись войнича"
</p>
<div class="clue-box">
    <p class="font-bold text-lg text-indigo-300 mb-2">УЛИКА 6: ЗАКЛЮЧЕНИЕ КРИПТОАНАЛИТИЧЕСКОГО СОВЕТА</p>
    <p class="text-sm">"Отсутствие ошибок, неестественное распределение символов, вымышленные иллюстрации... Ведущая гипотеза: это текст, созданный для того, чтобы выглядеть зашифрованным, вероятно, с целью продажи за крупную сумму как алхимический обман."</p>
    <p class="text-xs mt-2 text-gray-400">
        <span class='text-red-400'>Ключ к финалу:</span> Какое слово наиболее точно описывает создание фальшивки с целью получения выгоды?
    </p>
</div>

<span class='text-indigo-300'>ЗАДАНИЕ:</span> Сформулируйте окончательный вывод. Введите ОДНО слово, описывающее создание загадки с целью обмана (рус. яз., нижний регистр).`,
            taskType: 'finalConclusion',
            task: {
                question: "Введите ОДНО слово, описывающее обман:",
                correctAnswer: "мистификация",
                successMsg: (input) => {
                    return `
                    <span class='text-green-400'>ОКОНЧАТЕЛЬНЫЙ АНАЛИЗ:</span> ПРИНЯТ. ${input.toUpperCase()}.
                    
                    <hr class='my-4 border-gray-600'>
                    
                    <h3 class='text-2xl font-bold text-red-400'>ПРОТОКОЛ ВЫПОЛНЕН: ИСТИНА РУКОПИСИ ВОЙНИЧА</h3>
                    <p>Ваш вывод полностью совпадает с ведущей криптоаналитической теорией: Рукопись Войнича — это, скорее всего, <span class='font-extrabold text-red-300'>${input.toUpperCase()}</span>, блестяще выполненная с использованием пергамента XV века для придания ей подлинности. Цель: финансовая выгода или розыгрыш. Ваше расследование завершено. </p>
                    `;
                },
                nextStage: 7,
                hints: ["ведущая теория о рукописи войнича", "войнич мистификация"]
            }
        }
    ];

    /** Updates the attempts counter in the UI */
    function updateAttemptsDisplay() {
        document.getElementById('attemptsDisplay').textContent = gameState.attempts;
    }

    /** Show Modal Window */
    function showModal(title, message, isError = false) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').innerHTML = message;
        
        document.getElementById('modalTitle').classList.remove('text-red-400', 'text-green-400');
        document.getElementById('modalTitle').classList.add(isError ? 'text-red-400' : 'text-green-400');

        document.getElementById('messageModal').classList.remove('hidden');
    }

    /** Hide Modal Window */
    function hideModal() {
        document.getElementById('messageModal').classList.add('hidden');
        
        const isError = document.getElementById('modalTitle').classList.contains('text-red-400');
        
        if (gameState.attempts <= 0 && isError) {
            handleGameOver();
        } else if (!isError) {
            // Success: transition stage
            // This is the correct logic for advancing the stage after a successful quiz answer or the start button.
            if (stages[gameState.currentStage].task.nextStage) {
                gameState.currentStage = stages[gameState.currentStage].task.nextStage;
            }
            loadStage(gameState.currentStage);
        } else {
             // Error, attempts > 0: reload current stage.
             loadStage(gameState.currentStage);
        }
    }

    /** Game Over */
    function handleGameOver() {
        showModal("МИССИЯ ПРОВАЛЕНА", "Ваши попытки исчерпаны. Доступ к архиву заблокирован. Тайна Рукописи Войнича останется неразгаданной.", true);
        document.getElementById('interactionArea').innerHTML = `<p class="text-3xl text-red-400 font-bold mt-8 text-center">РАССЛЕДОВАНИЕ ЗАКРЫТО.</p>`;
    }

    /** General Failure Handler */
    function handleFailure(message) {
        gameState.attempts--;
        updateAttemptsDisplay();
        document.getElementById('terminalOutput').classList.add('incorrect-answer');
        setTimeout(() => document.getElementById('terminalOutput').classList.remove('incorrect-answer'), 500);

        if (gameState.attempts <= 0) {
            handleGameOver();
        } else {
            handleTextQuizError(message);
        }
    }
    
    /** Specific handler for quiz errors to show remaining attempts */
    function handleTextQuizError(message) {
         showModal("ОШИБКА АНАЛИЗА", message + `<br><br>У вас осталось **${gameState.attempts}** попыток. Пересмотрите УЛИКИ.`, true);
    }

    /** Reveals the hidden Google queries (Hint) */
    function revealHint() {
        const stageIndex = gameState.currentStage;
        const stageData = stages[stageIndex];
        
        if (!stageData.task.hints || gameState.hintsRevealed[stageIndex]) return;

        // Mark hint as revealed
        gameState.hintsRevealed[stageIndex] = true;
        
        // Use a modal to notify the user and then reload the stage
        showModal("ПОДСКАЗКА АКТИВИРОВАНА", "Поисковые запросы добавлены в Досье.", false);

        // NOTE: loadStage will be called by hideModal after the user closes the notification.
    }

    /** Loads and displays the current stage */
    function loadStage(stageIndex) {
        if (stageIndex >= stages.length) {
            document.getElementById('stageDisplay').textContent = "ЗАВЕРШЕНО";
            return;
        }

        const stageData = stages[stageIndex];
        const outputElement = document.getElementById('terminalOutput');
        const interactionElement = document.getElementById('interactionArea');
        
        document.getElementById('stageDisplay').textContent = gameState.stageNames[stageIndex];
        updateAttemptsDisplay();
        
        outputElement.innerHTML = `<span class='font-bold text-indigo-300'>${gameState.stageNames[stageIndex]}</span>\n\n${stageData.output}`;
        
        if (stageData.taskType === 'text' || stageData.taskType === 'finalConclusion') {
            outputElement.innerHTML += `<p class="mt-6 text-yellow-400 font-bold">ЗАДАНИЕ: ${stageData.task.question}</p>`;
        }
        
        // If hint was revealed, display the hint content
        if (gameState.hintsRevealed[stageIndex] && stageData.task.hints) {
            let hintHtml = `<div class="hint-box"><p class="font-bold text-yellow-400 mb-2">ПОДСКАЗКА ДЛЯ GOOGLE:</p><ul>`;
            stageData.task.hints.forEach(hint => {
                hintHtml += `<li><span class="text-green-400">→</span> "${hint}"</li>`;
            });
            hintHtml += `</ul></div>`;
            outputElement.innerHTML += hintHtml; 
        }


        interactionElement.innerHTML = '';

        if (stageIndex === 0) {
            // Start button
            const button = document.createElement('button');
            button.textContent = stageData.task.buttonText;
            button.className = 'action-button w-full bg-indigo-600 text-white py-3 font-semibold hover:bg-indigo-700';
            button.onclick = () => handleSuccess(stageData, null);
            interactionElement.appendChild(button);
        } else if (stageData.taskType === 'text' || stageData.taskType === 'finalConclusion') {
            // Text input for quiz
            const task = stageData.task;
            
            const inputGroup = document.createElement('div');
            inputGroup.className = 'flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4';
            
            const inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.id = 'stageInput';
            inputField.className = 'flex-grow p-3 text-input';
            inputField.placeholder = "Введите ключевое слово...";
            
            const button = document.createElement('button');
            button.id = 'submitBtn';
            button.textContent = 'ПОДТВЕРДИТЬ УЛИКУ';
            button.className = 'action-button bg-red-600 text-white py-3 px-6 font-semibold hover:bg-red-700 w-full md:w-auto';
            button.onclick = () => {
                if (stageData.taskType === 'finalConclusion') {
                    handleFinalConclusion(task, stageData);
                } else {
                    handleTextQuiz(task, stageData);
                }
            };

            // Hint Button
            const hintButton = document.createElement('button');
            hintButton.id = 'hintBtn';
            hintButton.textContent = gameState.hintsRevealed[stageIndex] ? "ПОДСКАЗКА АКТИВИРОВАНА" : "ПОЛУЧИТЬ ПОДСКАЗКУ";
            hintButton.className = 'action-button bg-yellow-600 text-white py-3 px-6 font-semibold hover:bg-yellow-700 w-full';
            // Disable button if hint is already revealed
            hintButton.disabled = gameState.hintsRevealed[stageIndex] === true; 
            hintButton.onclick = revealHint;
            
            // Handle Enter keypress
            inputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent form submission
                    button.click();
                }
            });
            
            inputGroup.appendChild(inputField);
            inputGroup.appendChild(button);
            interactionElement.appendChild(inputGroup);
            interactionElement.appendChild(hintButton);
        }
    }

    /** Handles Text Input Quiz */
    function handleTextQuiz(task, stageData) {
        const input = document.getElementById('stageInput').value.trim().toLowerCase();
        
        if (input === task.correctAnswer.toLowerCase()) {
            handleSuccess(stageData, input);
        } else if (input.length < 3) {
            showModal("ВНИМАНИЕ", "Введите ключевое слово для продолжения расследования.", true);
        } else {
            handleFailure(`Неверный ключевой фактор: '${input}'. Внимательно изучите УЛИКИ и СВОДКИ.`);
        }
    }

    /** Handles Final Conclusion */
    function handleFinalConclusion(finalTask, stageData) {
        const input = document.getElementById('stageInput').value.trim().toLowerCase();

        if (input === finalTask.correctAnswer.toLowerCase()) {
            document.getElementById('terminalOutput').innerHTML += finalTask.successMsg(input);
            document.getElementById('interactionArea').innerHTML = `<p class="text-xl text-green-400 font-bold text-center">ПРОТОКОЛ ЗАВЕРШЕН</p>`;
            gameState.currentStage = finalTask.nextStage;
            document.getElementById('stageDisplay').textContent = "РАЗГАДАН";
        } else if (input.length < 3) {
            showModal("ВНИМАНИЕ", "Введите ключевое слово для обоснования вашего вывода.", true);
        }
        else {
            handleFailure(`Ваш ключевой фактор ('${input}') не отражает окончательной исторической теории о природе рукописи.`);
        }
    }

    /** General Success Handler */
    function handleSuccess(stageData, input) {
        showModal("АНАЛИЗ УСПЕШЕН", stageData.task.successMsg, false);
    }

    // Initialize the game
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize hints state for all quiz stages (1-6)
        for(let i = 1; i < stages.length; i++) {
            if (gameState.hintsRevealed[i] === undefined) {
                 gameState.hintsRevealed[i] = false;
            }
        }
        loadStage(gameState.currentStage);
    });
</script>

</body>
</html>
